% This document is designed to produce a french speaking report.

\documentclass{article}
\usepackage[T1]{fontenc}
\usepackage[main=english]{babel}
\usepackage{url}
\usepackage{lastpage}
\usepackage{fancyhdr}
\usepackage{graphicx}
\usepackage[a4paper, margin=2cm, footskip=18.3pt]{geometry}
\usepackage{listings}
\usepackage{pdflscape}
\usepackage{color}

\newcommand{\header} {
    \setlength{\headheight}{30pt}\pagestyle{fancy}
    \fancyhead[L]{\includegraphics[height=20pt]{~/Templates/heig-logo}}\fancyhead[C]{PCO 2023\\ Lab 4}
    \fancyhead[R]{Timoth√©e Van Hove et Aubry Mangold\\\today}\fancyfoot[C]{}
    \fancyfoot[R]{Page \thepage~sur \pageref{LastPage}}\renewcommand{\footrulewidth}{0.3pt}
}

\lstset{frame=tb,
    language=C++,
    aboveskip=3mm,
    belowskip=3mm,
    showstringspaces=false,
    columns=flexible,
    basicstyle={\small\ttfamily},
    numbers=none,
    numberstyle=\tiny\color{gray},
    keywordstyle=\color{blue},
    commentstyle=\color{dkgreen},
    stringstyle=\color{mauve},
    breaklines=true,
    breakatwhitespace=true,
    tabsize=3
}

\begin{document}
    \header


    \section{Introduction}

    The goal of this lab is to implement the management of a shared rail section in a train simulation.
    The source code of the simulator and a program boilerplate for the student program are provided.
    The simulator is a multithreaded program that simulates the behavior of a train on a rail network, leading to
    synchronization problems.
    The student program must implement the management of the shared rail section, the synchronization between the trains
    at the station and an emergency stop system.

    \section{Analysis}
% Talk about the problems arising from having two trains running on two threads that need to be synchoronized
%    Shared resources
%    Critical sections
%    Synchronization
%    Deadlocks

In a concurrent system where two trains are operated by separate threads, it is a synchronization challenge to ensure that both trains coexist in areas where their paths intersect or overlap (critical sections). Critical sections in this context include shared track sections and stations. The tracks, particularly the shared sections, act as shared resources. Without proper synchronization, both trains could attempt to occupy the same section simultaneously, leading to a collision in the simulation. Deadlocks are a significant risk. With two trains, this could occur if both attempt to enter the same shared section from opposite ends and wait indefinitely for the other to leave. Similar to shared sections, stations are points where special synchronization is needed. Both trains might need to use the station simultaneously.

    \section{Conception}
% Talk about how train blocks work in real life TIM: Really necessary?
% Talk about which concepts we've used to solve the problem
% Sections: shared section, station, emergency stop

To address station synchronization, we implemented a barrier mechanism. This ensures that trains can only leave the station when it is fully occupied. Additionally, we integrated a priority system within this barrier, giving precedence to the last train arriving at the station to depart first when the barrier is lifted.

For managing the shared section, we established a synchronization logic. This system ensures that while one train occupies this critical section, the other train waits. As soon as the first train exits the section, the waiting train receives clearance to enter. This approach effectively prevents conflicts and ensures safe passage through the shared track section.

    \section{Implementation}
% Briefly talk about the implementation, giving code examples where necessary

    In the implementation of our train simulation system, we began by creating distinct routes for each locomotive. These routes are dynamically generated using the routeFactory function, which not only sets up specific track junction configurations but also establishes parameters for each train's journey, including how they navigate shared track sections.

    In the main function, we initialize the model railway system, including setting up the model turnouts based on the selected route. Locomotives A and B are initialized with unique identifiers and predetermined speeds, and their starting positions are determined by the route configuration. Then, two threads launch an instance of the runnable locomotivebehavior class. In this class, the run() method is responsible for dictating the locomotive's actions, encompassing station stops, navigation through shared sections, and responses to track junctions.

    Synchronization of shared track sections is a critical aspect of our implementation. We employed the Synchro class to manage access to these sections. The methods access(), leave(), and stopAtStation() ensure that only one train occupies a shared section at any given time, effectively preventing the risk of collisions.

    Station management is another key feature. To control access to the station and ensure orderly operation, we implemented a barrier-like mechanism. This approach not only manages station occupancy but also assigns departure priority to the last train that arrives at the station.

    For safety, an emergency stop function was integrated. This function can be invoked to immediately halt both locomotives, setting their speeds to zero and ensuring an instantaneous stop.

    The simulation is initiated with the launching of the locomotive threads. It runs continuously, monitoring for any external conditions or the activation of the emergency stop, which would bring the operation to a halt. Upon conclusion, the simulation is gracefully terminated, ensuring the proper shutdown of all threads and the safe state of the train model system.

%Code listing
    \begin{lstlisting}
    \end{lstlisting}


    \section{Tests}

    \subsection*{Shared section}
    % Describe the tests we've done to ensure the correctness of our implementation. This section is worth some points.
    In the testing phase of our train simulation system, we conducted a series of tests to ensure the robustness and reliability of our implementation. These tests were designed to cover a variety of scenarios, each introducing different complexities and challenges.

    \textbf{Testing with the Provided Train Route:} Initially, we tested the system using the provided default train route. This served as a baseline to verify the fundamental functionality of our implementation, including basic movement of the trains and basic synchronization in shared sections and at stations.

    \textbf{Shared Section Adjacent to the Station:} In this test, we evaluated the system's behavior when the shared section is located immediately next to the station. This scenario tested the synchronization logic's ability to handle rapid access to the shared section and the station.

    \textbf{Shared Section Just Before the Station:} Another scenario placed the shared section right before the station. This setup was aimed to tes the system's handling the efficiency of our synchronization mechanism, as trains transitioned quickly from a shared section to a station stop.

    \textbf{Shared Section Separated from the Station:} We also tested a route where the shared section was separated from the station by a few blocks. This scenario was aimed at evaluating the system under a more spread-out configuration, ensuring that our synchronization logic remained effective.

    \textbf{Route with Two Shared Sections:} Going further, we introduced a route featuring two shared sections. This more complex scenario tested the system's capability to manage multiple critical sections simultaneously, ensuring that each train could navigate through these sections without conflicts or deadlocks.

    \textbf{Route with Only a Station and a Shared Section:} Finally, we tested a minimalist route that included only a station and a shared section. This scenario allowed us to focus on the core functionality of our system, ensuring that even in a simplified setup, the trains could coordinate effectively, demonstrating the scalability and adaptability of our synchronization logic.


    \subsection*{Station synchronization}

    \subsection*{Emergency stop}

    \section{Conclusion}

    \appendix

    \section{Train routes}
    % images of the train routes used in the tests

\end{document}
